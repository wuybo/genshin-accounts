<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åŸç¥è´¦å·ä¿¡æ¯</title>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
      background: #f9f9f9;
      padding: 0;
      margin: 0;
    }

    /* é¡µé¢é¡¶éƒ¨æ ‡é¢˜æ  */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f9f9f9;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #5e35b1;
      margin: 8px 0;
      font-size: 1.6em;
    }

    .search-box {
      text-align: center;
      margin-top: 12px;
    }
    #searchInput {
      width: 90%;
      max-width: 500px;
      padding: 10px 15px;
      font-size: 16px;
      border: 2px solid #5e35b1;
      border-radius: 8px;
      outline: none;
    }

    /* è¿‡æ»¤å’Œæ’åºæ§åˆ¶æ  */
    .controls-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      padding: 0 20px;
    }

    .server-tags {
      display: flex;
      gap: 10px;
    }

    .server-tag {
      padding: 8px 16px;
      background: #f0f0f0;
      border: 2px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .server-tag:hover {
      background: #e0e0e0;
    }

    .server-tag.active {
      background: #5e35b1;
      color: white;
      border-color: #5e35b1;
    }

    .sort-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sort-btn {
      padding: 8px 16px;
      background: #f0f0f0;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .sort-btn:hover {
      background: #e0e0e0;
    }

    .sort-btn.active {
      background: #5e35b1;
      color: white;
      border-color: #5e35b1;
    }

    .sort-btn::after {
      content: ' â†•';
      opacity: 0.7;
    }

    .sort-btn.asc::after {
      content: ' â†‘';
    }

    .sort-btn.desc::after {
      content: ' â†“';
    }

    /* è¡¨æ ¼åŒºåŸŸ */
    .table-container {
      padding: 0 20px 20px;
      margin-top: 20px;
    }

    /* å›ºå®šè¡¨æ ¼è¡¨å¤´ */
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: calc(100vh - 320px); /* å¢åŠ é«˜åº¦ä»¥é€‚åº”å¢åŠ çš„æ§ä»¶ */
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      background: white;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    
    /* å›ºå®šè¡¨å¤´ */
    thead {
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    th {
      background-color: #ede7f6;
      color: #5e35b1;
      font-weight: bold;
      padding: 12px 10px;
      text-align: left;
      border-bottom: 2px solid #d1c4e9;
      white-space: nowrap;
    }
    
    td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background-color: #f5f3fa;
    }
    
    .price {
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.1em;
    }
    
    .wrap {
      word-break: break-word;
      max-width: 180px;
    }
    
    /* é«˜äº®æ ·å¼ */
    mark {
      background-color: #fff176;
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    .highlight {
      background-color: #fff176;
      animation: highlightPulse 1.5s ease-in-out;
    }
    
    @keyframes highlightPulse {
      0% { background-color: #fff176; }
      50% { background-color: #ffeb3b; }
      100% { background-color: #fff176; }
    }
    
    .no-results {
      text-align: center;
      padding: 30px;
      color: #888;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      color: #5e35b1;
    }

    /* åˆ†é¡µæ§ä»¶æ ·å¼ */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      background: white;
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .pagination-info {
      margin-left: 20px;
      color: #666;
      font-size: 14px;
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 20px;
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .page-size-selector select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    .page-navigation {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .page-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      min-width: 36px;
      text-align: center;
    }

    .page-btn:hover:not(:disabled) {
      background: #f0f0f0;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: #5e35b1;
      color: white;
      border-color: #5e35b1;
    }

    .page-input {
      width: 50px;
      padding: 6px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .go-btn {
      padding: 6px 12px;
      background: #5e35b1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .go-btn:hover {
      background: #4527a0;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .sticky-header {
        padding: 15px 10px;
      }
      h1 { font-size: 1.4em; }
      
      .controls-bar {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 0 10px;
      }
      
      .server-tags {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .table-wrapper {
        overflow-x: auto;
        max-height: calc(100vh - 300px);
      }
      
      table {
        min-width: 800px;
      }
      
      td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .wrap {
        max-width: 150px;
        white-space: normal;
      }

      .pagination-container {
        flex-direction: column;
        gap: 15px;
        padding: 15px 10px;
      }

      .pagination-info {
        margin-left: 0;
        order: 3;
      }

      .pagination-controls {
        margin-right: 0;
        flex-wrap: wrap;
        justify-content: center;
      }

      .page-size-selector {
        order: 1;
      }

      .page-navigation {
        order: 2;
      }
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .table-wrapper::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 4px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>

<!-- é¡µé¢é¡¶éƒ¨æ ‡é¢˜æ  -->
<div class="sticky-header">
  <h1>åŸç¥è´¦å·ä¿¡æ¯åˆ—è¡¨</h1>
  <h1>Genshin Impact Account Information List</h1>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æœåŠ¡å™¨ã€è§’è‰²ã€ä»·æ ¼ã€æ€§åˆ«ç­‰(Search by server, character, price, gender, etc.)..." autocomplete="off" />
  </div>
  
  <!-- è¿‡æ»¤å’Œæ’åºæ§åˆ¶æ  -->
  <div class="controls-bar">
    <div class="server-tags">
      <div class="server-tag" data-server="æ¬§æ´²">æ¬§æœ Europe</div>
      <div class="server-tag" data-server="ç¾æ´²">ç¾æœ America</div>
      <div class="server-tag" data-server="äºšæ´²">äºšæœ Asia</div>
      <div class="server-tag" data-server="">å…¨éƒ¨ All</div>
    </div>
    
    <div class="sort-controls">
      <span>ä»·æ ¼æ’åº:</span>
      <button class="sort-btn" data-sort="default">é»˜è®¤</button>
      <button class="sort-btn" data-sort="price_asc">ä»·æ ¼å‡åº</button>
      <button class="sort-btn" data-sort="price_desc">ä»·æ ¼é™åº</button>
    </div>
  </div>
</div>

<!-- è¡¨æ ¼åŒºåŸŸ -->
<div class="table-container">
  <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
  
  <!-- æ·»åŠ è¡¨æ ¼åŒ…è£…å™¨ï¼Œç”¨äºå›ºå®šè¡¨å¤´ -->
  <div class="table-wrapper">
    <table id="accountTable" style="display:none;">
      <thead>
        <tr>
          <th>æœåŠ¡å™¨ï¼ˆä¸­ï¼‰</th>
          <th>Serverï¼ˆEnï¼‰</th>
          <th>æ€§åˆ«(Gender)</th>
          <th>ç­‰çº§(Level)</th>
          <th>åŸçŸ³</th>
          <th>çº ç¼ ä¹‹ç¼˜</th>
          <th>è§’è‰²ï¼ˆä¸­æ–‡ï¼‰</th>
          <th>Characterï¼ˆENï¼‰</th>
          <th>äº”æ˜Ÿè§’è‰²æ•°é‡(5â˜…No.)</th>
          <th>ä»·æ ¼Priceï¼ˆÂ¥ï¼‰</th>
          <th>è´¦å·ç±»å‹</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <div id="noResults" class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„è´¦å·</div>

  <!-- åˆ†é¡µæ§ä»¶ -->
  <div id="paginationContainer" class="pagination-container" style="display:none;">
    <div class="pagination-info" id="paginationInfo">
      æ˜¾ç¤ºç¬¬ <span id="startRecord">0</span> - <span id="endRecord">0</span> æ¡ï¼Œå…± <span id="totalRecords">0</span> æ¡è®°å½•
    </div>
    
    <div class="pagination-controls">
      <div class="page-size-selector">
        <label>æ¯é¡µæ˜¾ç¤ºï¼š</label>
        <select id="pageSizeSelect">
          <option value="50">50æ¡</option>
          <option value="100">100æ¡</option>
          <option value="150">150æ¡</option>
          <option value="200">200æ¡</option>
        </select>
      </div>
      
      <div class="page-navigation">
        <button id="firstPage" class="page-btn" title="ç¬¬ä¸€é¡µ">Â«</button>
        <button id="prevPage" class="page-btn" title="ä¸Šä¸€é¡µ">â€¹</button>
        
        <input type="number" id="pageInput" class="page-input" min="1" value="1" />
        <span> / </span>
        <span id="totalPages">1</span>
        
        <button id="nextPage" class="page-btn" title="ä¸‹ä¸€é¡µ">â€º</button>
        <button id="lastPage" class="page-btn" title="æœ€åä¸€é¡µ">Â»</button>
        
        <button id="goPage" class="go-btn">è·³è½¬</button>
      </div>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const tableBody = document.getElementById('tableBody');
  const table = document.getElementById('accountTable');
  const loading = document.getElementById('loading');
  const noResults = document.getElementById('noResults');
  const paginationContainer = document.getElementById('paginationContainer');

  // åˆ†é¡µç›¸å…³å…ƒç´ 
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  const firstPageBtn = document.getElementById('firstPage');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const lastPageBtn = document.getElementById('lastPage');
  const pageInput = document.getElementById('pageInput');
  const goPageBtn = document.getElementById('goPage');
  const totalPagesSpan = document.getElementById('totalPages');
  const totalRecordsSpan = document.getElementById('totalRecords');
  const startRecordSpan = document.getElementById('startRecord');
  const endRecordSpan = document.getElementById('endRecord');

  // æœåŠ¡å™¨æ ‡ç­¾å’Œæ’åºæŒ‰é’®
  const serverTags = document.querySelectorAll('.server-tag');
  const sortButtons = document.querySelectorAll('.sort-btn');

  // çŠ¶æ€å˜é‡
  let currentPage = 1;
  let currentLimit = 50;
  let currentSearch = '';
  let currentServer = '';
  let currentSort = 'default';
  let totalPages = 1;
  let totalRecords = 0;
  let allData = [];

  // é˜²æŠ–å‡½æ•°ï¼Œå‡å°‘æœç´¢è¯·æ±‚é¢‘ç‡
  let searchTimeout = null;
  const DEBOUNCE_DELAY = 300;

  // åˆå§‹åŒ–é¡µé¢
  document.addEventListener('DOMContentLoaded', () => {
    fetchAccounts();
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    searchInput.addEventListener('input', handleSearch);
    pageSizeSelect.addEventListener('change', handlePageSizeChange);
    firstPageBtn.addEventListener('click', () => changePage(1));
    prevPageBtn.addEventListener('click', () => changePage(currentPage - 1));
    nextPageBtn.addEventListener('click', () => changePage(currentPage + 1));
    lastPageBtn.addEventListener('click', () => changePage(totalPages));
    goPageBtn.addEventListener('click', handleGoToPage);
    pageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleGoToPage();
    });
    
    // ç»‘å®šæœåŠ¡å™¨æ ‡ç­¾äº‹ä»¶
    serverTags.forEach(tag => {
      tag.addEventListener('click', () => {
        const server = tag.dataset.server;
        setActiveServer(server);
        currentPage = 1;
        fetchAccounts();
      });
    });
    
    // ç»‘å®šæ’åºæŒ‰é’®äº‹ä»¶
    sortButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const sort = btn.dataset.sort;
        setActiveSort(sort);
        currentPage = 1;
        fetchAccounts();
      });
    });
  });

  // è®¾ç½®æ´»åŠ¨æœåŠ¡å™¨æ ‡ç­¾
  function setActiveServer(server) {
    serverTags.forEach(tag => {
      if (tag.dataset.server === server) {
        tag.classList.add('active');
      } else {
        tag.classList.remove('active');
      }
    });
    currentServer = server;
  }

  // è®¾ç½®æ´»åŠ¨æ’åºæŒ‰é’®
  function setActiveSort(sort) {
    sortButtons.forEach(btn => {
      btn.classList.remove('active', 'asc', 'desc');
      if (btn.dataset.sort === sort) {
        btn.classList.add('active');
        if (sort === 'price_asc') btn.classList.add('asc');
        if (sort === 'price_desc') btn.classList.add('desc');
      }
    });
    currentSort = sort;
  }

  // å¤„ç†æœç´¢
  function handleSearch() {
    currentSearch = searchInput.value.trim();
    currentPage = 1;
    
    // é˜²æŠ–å¤„ç†
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      fetchAccounts();
    }, DEBOUNCE_DELAY);
  }

  // å¤„ç†æ¯é¡µæ•°é‡å˜åŒ–
  function handlePageSizeChange() {
    currentLimit = parseInt(pageSizeSelect.value);
    currentPage = 1;
    fetchAccounts();
  }

  // å¤„ç†è·³è½¬åˆ°æŒ‡å®šé¡µé¢
  function handleGoToPage() {
    const pageNum = parseInt(pageInput.value);
    if (pageNum && pageNum >= 1 && pageNum <= totalPages) {
      changePage(pageNum);
    } else {
      pageInput.value = currentPage;
    }
  }

  // æ”¹å˜é¡µé¢
  function changePage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    currentPage = page;
    pageInput.value = page;
    fetchAccounts();
  }

  // è·å–è´¦å·æ•°æ®
  async function fetchAccounts() {
    try {
      loading.style.display = 'block';
      table.style.display = 'none';
      noResults.style.display = 'none';
      paginationContainer.style.display = 'none';

      // æ„å»ºè¯·æ±‚URL
      let url = `http://116.62.131.121:8092/accounts?page=${currentPage}&limit=${currentLimit}`;
      
      // æ·»åŠ æœç´¢å‚æ•°
      if (currentSearch) {
        url += `&search=${encodeURIComponent(currentSearch)}`;
      }
      
      // æ·»åŠ æœåŠ¡å™¨ç­›é€‰å‚æ•°
      if (currentServer) {
        url += `&server=${encodeURIComponent(currentServer)}`;
      }
      
      // æ·»åŠ æ’åºå‚æ•°
      if (currentSort !== 'default') {
        url += `&sort=${currentSort}`;
      }

      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      
      const result = await response.json();
      
      // ä¿å­˜æ‰€æœ‰æ•°æ®ç”¨äºå‰ç«¯é«˜äº®
      if (currentPage === 1) {
        allData = result.data;
      }
      
      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      updatePaginationInfo(result.pagination);
      
      // æ¸²æŸ“è¡¨æ ¼
      renderTable(result.data);
      
      loading.style.display = 'none';
      table.style.display = 'table';
      paginationContainer.style.display = 'flex';
      
      if (result.data.length === 0) {
        noResults.style.display = 'block';
        noResults.textContent = currentSearch || currentServer ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è´¦å·' : 'æš‚æ— è´¦å·æ•°æ®';
      }
      
    } catch (err) {
      loading.innerHTML = `<span style="color:#d32f2f">âŒ åŠ è½½å¤±è´¥: ${err.message}</span>`;
      console.error('åŠ è½½é”™è¯¯:', err);
    }
  }

  // æ›´æ–°åˆ†é¡µä¿¡æ¯
  function updatePaginationInfo(pagination) {
    totalPages = pagination.total_pages;
    totalRecords = pagination.total_records;
    currentPage = pagination.current_page;
    
    totalPagesSpan.textContent = totalPages;
    totalRecordsSpan.textContent = totalRecords;
    
    const start = (currentPage - 1) * currentLimit + 1;
    const end = Math.min(currentPage * currentLimit, totalRecords);
    startRecordSpan.textContent = start;
    endRecordSpan.textContent = end;
    
    pageInput.value = currentPage;
    pageInput.max = totalPages;
    
    firstPageBtn.disabled = currentPage === 1;
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;
    lastPageBtn.disabled = currentPage === totalPages;
  }

  // æ¸²æŸ“è¡¨æ ¼å¹¶æ·»åŠ é«˜äº®
  function renderTable(data) {
    tableBody.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('tr');
      
      // å¯¹æœç´¢å…³é”®è¯è¿›è¡Œé«˜äº®å¤„ç†
      const highlightText = currentSearch.toLowerCase();
      
      row.innerHTML = `
        <td>${highlightText ? highlightTextInCell(item.server_cn, highlightText) : escapeHtml(item.server_cn)}</td>
        <td>${highlightText ? highlightTextInCell(item.server_en, highlightText) : escapeHtml(item.server_en)}</td>
        <td>${highlightText ? highlightTextInCell(item.gender_cn, highlightText) : escapeHtml(item.gender_cn)}</td>
        <td>${item.level}</td>
        <td>${item.primogems}</td>
        <td>${item.intertwined_fate}</td>
        <td class="wrap">${highlightText ? highlightTextInCell(item.characters_cn, highlightText) : escapeHtml(item.characters_cn)}</td>
        <td class="wrap">${highlightText ? highlightTextInCell(item.characters_en, highlightText) : escapeHtml(item.characters_en)}</td>
        <td>${item.five_star_count}</td>
        <td class="price">${item.price}</td>
        <td>${highlightText ? highlightTextInCell(item.account_type, highlightText) : escapeHtml(item.account_type)}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  // æ–‡æœ¬é«˜äº®å‡½æ•°
  function highlightTextInCell(text, searchText) {
    if (!text || !searchText) return escapeHtml(text);
    
    const escapedText = escapeHtml(text);
    const regex = new RegExp(`(${escapeRegExp(searchText)})`, 'gi');
    
    return escapedText.replace(regex, '<mark class="highlight">$1</mark>');
  }

  // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // HTMLè½¬ä¹‰å‡½æ•°
  function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

</body>
</html>
